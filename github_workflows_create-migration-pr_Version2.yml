name: Create migration & PR - migrate devices.model -> device_type_id + device variables

on:
  workflow_dispatch:

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure directories
        run: |
          mkdir -p db/migrations scripts devices admin

      - name: Write migration and files
        run: |
          # migration 1 (model -> device_type_id)
          cat > db/migrations/2026_02_migrate_devices_to_device_type_id.sql <<'SQL'
-- 2026-02-15
-- Safe migration: migrate devices.model -> devices.device_type_id
-- IMPORTANT: BACKUP YOUR DATABASE BEFORE RUNNING THIS SCRIPT.
-- Run this on a staging/test database first and verify results using the queries provided below.

START TRANSACTION;

-- 0) Ensure device_types table exists
CREATE TABLE IF NOT EXISTS device_types (
  id INT AUTO_INCREMENT PRIMARY KEY,
  type_name VARCHAR(128) NOT NULL UNIQUE,
  description TEXT DEFAULT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 0b) Ensure variables table exists (used by config builder)
CREATE TABLE IF NOT EXISTS variables (
  id INT AUTO_INCREMENT PRIMARY KEY,
  var_name VARCHAR(128) NOT NULL UNIQUE,
  var_value TEXT NOT NULL,
  description TEXT DEFAULT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 1) Add device_type_id to devices (nullable for safety)
ALTER TABLE devices
  ADD COLUMN IF NOT EXISTS device_type_id INT NULL DEFAULT NULL,
  ADD INDEX idx_device_type_id (device_type_id);

-- 2) Ensure device_types exist for distinct model strings (insert missing)
INSERT INTO device_types (type_name, description)
SELECT DISTINCT d.model, NULL
FROM devices d
LEFT JOIN device_types dt ON dt.type_name = d.model
WHERE d.model IS NOT NULL AND d.model <> '' AND dt.id IS NULL;

-- 3) Populate device_type_id by joining on device_types.type_name
UPDATE devices d
JOIN device_types dt ON dt.type_name = d.model
SET d.device_type_id = dt.id
WHERE d.model IS NOT NULL AND d.model <> '';

-- 4) Ensure fallback 'Unknown' exists
INSERT IGNORE INTO device_types (type_name, description) VALUES ('Unknown', 'Fallback type for existing devices without a model');

-- 5) Assign 'Unknown' to any devices still without a device_type_id
UPDATE devices d
JOIN device_types dt ON dt.type_name = 'Unknown'
SET d.device_type_id = dt.id
WHERE d.device_type_id IS NULL;

COMMIT;

-- VALIDATION SUGGESTIONS (run manually after migration)
-- SELECT COUNT(*) FROM device_types;
-- SELECT COUNT(*) FROM devices WHERE device_type_id IS NULL;
-- SELECT d.id, d.device_name, d.mac_address, dt.type_name FROM devices d LEFT JOIN device_types dt ON d.device_type_id = dt.id LIMIT 50;

-- OPTIONAL FINAL STEPS (UNCOMMENT & RUN ONLY AFTER YOU'VE VERIFIED BACKUP & STAGING)
-- ALTER TABLE devices MODIFY device_type_id INT NOT NULL;
-- ALTER TABLE devices ADD CONSTRAINT fk_devices_device_type FOREIGN KEY (device_type_id) REFERENCES device_types(id) ON DELETE RESTRICT ON UPDATE CASCADE;
-- ALTER TABLE devices DROP COLUMN model;
SQL

          # migration 2 (device variables)
          cat > db/migrations/2026_02_add_device_variables.sql <<'SQL'
-- 2026-02-15
-- Add device-specific and device-type-specific variable tables

START TRANSACTION;

CREATE TABLE IF NOT EXISTS device_variables (
  id INT AUTO_INCREMENT PRIMARY KEY,
  device_id INT NOT NULL,
  var_name VARCHAR(128) NOT NULL,
  var_value TEXT NOT NULL,
  created_by INT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY ux_device_var (device_id, var_name),
  INDEX idx_device_id (device_id)
  -- FOREIGN KEY (device_id) REFERENCES devices(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE IF NOT EXISTS device_type_variables (
  id INT AUTO_INCREMENT PRIMARY KEY,
  device_type_id INT NOT NULL,
  var_name VARCHAR(128) NOT NULL,
  var_value TEXT NOT NULL,
  created_by INT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY ux_type_var (device_type_id, var_name),
  INDEX idx_device_type_id (device_type_id)
  -- FOREIGN KEY (device_type_id) REFERENCES device_types(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

COMMIT;
SQL

          # updated apply script (runs both migrations and RBAC updates)
          cat > scripts/apply_migration_and_permissions.php <<'PHP'
#!/usr/bin/env php
<?php
// CLI script: apply migration SQL files and add RBAC permissions.
// Usage:
//   php scripts/apply_migration_and_permissions.php --files=db/migrations/2026_02_migrate_devices_to_device_type_id.sql,db/migrations/2026_02_add_device_variables.sql --yes
//
// Without --yes the script will perform a dry-run (showing statements) but will NOT execute them.
//
// WARNING: always BACKUP the DB before running.

if (php_sapi_name() !== 'cli') {
    echo "This script must be run from the command line.\n";
    exit(1);
}

$options = getopt("", ["files:", "yes"]);
$filesOpt = $options['files'] ?? 'db/migrations/2026_02_migrate_devices_to_device_type_id.sql,db/migrations/2026_02_add_device_variables.sql';
$files = array_filter(array_map('trim', explode(',', $filesOpt)));
$really = isset($options['yes']);

// locate config/database.php that defines $pdo
$configPathCandidates = [
    __DIR__ . '/../config/database.php',
    __DIR__ . '/../../config/database.php'
];

$loaded = false;
foreach ($configPathCandidates as $p) {
    if (file_exists($p)) {
        require_once $p;
        $loaded = true;
        break;
    }
}

if (!$loaded) {
    echo "Could not find config/database.php. Please ensure the script can include the PDO \$pdo instance.\n";
    exit(1);
}

if (!isset($pdo) || !($pdo instanceof PDO)) {
    echo "Database PDO \$pdo not found after including config. Ensure config/database.php defines \$pdo (PDO instance).\n";
    exit(1);
}

$allStatements = [];

foreach ($files as $file) {
    if (!file_exists($file)) {
        echo "SQL file not found: $file\n";
        exit(1);
    }
    $sql = file_get_contents($file);
    if ($sql === false) {
        echo "Failed to read SQL file: $file\n";
        exit(1);
    }
    // split naive by semicolon+newline (keeps comments intact but ok for our migrations)
    $stmts = array_filter(array_map('trim', preg_split('/;\\s*\\n/', $sql)));
    foreach ($stmts as $s) {
        if ($s !== '') $allStatements[] = $s;
    }
}

echo "=================================================================\n";
echo " Database Migration and RBAC Permissions Script\n";
echo "=================================================================\n";
echo "Mode: " . ($really ? "EXECUTE" : "DRY-RUN (use --yes to execute)") . "\n";
echo "Files to run:\n";
foreach ($files as $f) echo " - $f\n";
echo "=================================================================\n\n";

echo "Total statements parsed: " . count($allStatements) . "\n\n";

if (!$really) {
    echo "DRY-RUN MODE: The following SQL would be executed:\n";
    echo "--------------------------------------------------------------\n";
    foreach ($allStatements as $st) {
        echo $st . ";\n\n";
    }
    echo "--------------------------------------------------------------\n";
    echo "To execute this migration, run with --yes flag:\n";
    echo "php scripts/apply_migration_and_permissions.php --files=" . implode(',', $files) . " --yes\n";
    echo "=================================================================\n";
    exit(0);
}

// Execute statements inside a transaction
try {
    $pdo->beginTransaction();

    foreach ($allStatements as $st) {
        // skip comment-only statements
        $tmp = trim($st);
        if ($tmp === '' || preg_match('/^\\-\\-/', $tmp)) continue;
        $pdo->exec($st);
    }

    // RBAC permission inserts (safe: insert where role exists)
    $permStmts = [
        "INSERT IGNORE INTO role_permissions (role_id, permission) SELECT id, 'admin.device_types.manage' FROM roles WHERE role_name = 'Admin'",
        "INSERT IGNORE INTO role_permissions (role_id, permission) SELECT id, 'admin.variables.manage' FROM roles WHERE role_name = 'Admin'",
        "INSERT IGNORE INTO role_permissions (role_id, permission) SELECT id, 'variables.manage' FROM roles WHERE role_name = 'Admin'",
        "INSERT IGNORE INTO role_permissions (role_id, permission) SELECT id, 'admin.tokens.manage' FROM roles WHERE role_name = 'Admin'",
    ];

    foreach ($permStmts as $ps) {
        $pdo->exec($ps);
    }

    $pdo->commit();
    echo "Migration and permission updates executed successfully.\n";
    echo "Post-migration checks (recommended):\n";
    echo " - SELECT COUNT(*) FROM device_types;\n";
    echo " - SELECT COUNT(*) FROM device_variables;\n";
    echo " - SELECT COUNT(*) FROM devices WHERE device_type_id IS NULL;\n    ";
} catch (Exception $e) {
    $pdo->rollBack();
    echo "ERROR during migration: " . $e->getMessage() . "\n";
    exit(1);
}
PHP

          # devices/create.php (with variable UI + saving)
          cat > devices/create.php <<'PHP'
<?php
session_start();
require_once __DIR__ . '/../config/database.php';
require_once __DIR__ . '/../includes/rbac.php';

if (!isset($_SESSION['admin_id'])) {
    header('Location: /login.php');
    exit;
}
$admin_id = (int) $_SESSION['admin_id'];

if (!has_permission($pdo, $admin_id, 'devices.manage')) {
    http_response_code(403);
    echo 'Toegang geweigerd.';
    exit;
}

if (empty($_SESSION['csrf_token'])) {
    $_SESSION['csrf_token'] = bin2hex(random_bytes(16));
}
$csrf = $_SESSION['csrf_token'];

$error = '';
$success = '';

// Fetch device types
try {
    $stmt = $pdo->query('SELECT id, type_name FROM device_types ORDER BY type_name ASC');
    $types = $stmt->fetchAll(PDO::FETCH_ASSOC);
} catch (Exception $e) {
    error_log('devices/create fetch types error: ' . $e->getMessage());
    $types = [];
}

// Load global variables for optional overrides
try {
    $vstmt = $pdo->query('SELECT var_name, var_value FROM variables ORDER BY var_name ASC');
    $global_vars = $vstmt->fetchAll(PDO::FETCH_KEY_PAIR);
} catch (Exception $e) {
    $global_vars = [];
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (!hash_equals($csrf, $_POST['csrf_token'] ?? '')) {
        $error = 'Ongeldige aanvraag (CSRF).';
    } else {
        $name = trim((string)($_POST['device_name'] ?? ''));
        $device_type_id = (int)($_POST['device_type_id'] ?? 0);
        $mac_raw = trim((string)($_POST['mac_address'] ?? ''));
        $description = trim((string)($_POST['description'] ?? ''));

        if ($name === '' || $device_type_id <= 0) {
            $error = 'Vul minimaal de naam en het model in.';
        } else {
            // Normalize MAC if provided
            $mac = null;
            if ($mac_raw !== '') {
                $normalized = strtoupper(preg_replace('/[^0-9A-F]/i', '', $mac_raw));
                if (!preg_match('/^[0-9A-F]{12}$/', $normalized)) {
                    $error = 'Ongeldig MAC-adres.';
                } else {
                    $mac = implode(':', str_split($normalized, 2));
                }
            }

            if ($error === '') {
                try {
                    // check duplicate MAC if provided
                    if ($mac !== null) {
                        $chk = $pdo->prepare('SELECT id FROM devices WHERE mac_address = ? LIMIT 1');
                        $chk->execute([$mac]);
                        if ($chk->fetch()) {
                            $error = 'Er bestaat al een device met dit MAC-adres.';
                        }
                    }
                } catch (Exception $e) {
                    error_log('devices/create duplicate check error: ' . $e->getMessage());
                }
            }

            if ($error === '') {
                try {
                    $stmt = $pdo->prepare('INSERT INTO devices (device_name, device_type_id, mac_address, description, is_active, created_at, updated_at) VALUES (?, ?, ?, ?, 1, NOW(), NOW())');
                    $stmt->execute([$name, $device_type_id, $mac, $description]);
                    $newId = $pdo->lastInsertId();

                    // Save per-device variables (if any)
                    try {
                        $insVar = $pdo->prepare('INSERT INTO device_variables (device_id, var_name, var_value, created_by, created_at) VALUES (?, ?, ?, ?, NOW()) ON DUPLICATE KEY UPDATE var_value = VALUES(var_value), created_by = VALUES(created_by)');
                        $posted_vars = $_POST['variables'] ?? [];
                        foreach ($posted_vars as $varName => $varVal) {
                            $varName = strtoupper(trim((string)$varName));
                            $varVal = trim((string)$varVal);
                            if ($varName === '' || $varVal === '') continue;
                            if (!preg_match('/^[A-Z0-9_]+$/', $varName)) continue;
                            $insVar->execute([(int)$newId, $varName, $varVal, $admin_id]);
                        }
                        // custom variables arrays
                        $custom_names = $_POST['custom_var_name'] ?? [];
                        $custom_vals  = $_POST['custom_var_value'] ?? [];
                        for ($i=0;$i<count($custom_names);$i++){
                            $cn = strtoupper(trim((string)$custom_names[$i] ?? ''));
                            $cv = trim((string)$custom_vals[$i] ?? '');
                            if ($cn === '' || $cv === '') continue;
                            if (!preg_match('/^[A-Z0-9_]+$/', $cn)) continue;
                            $insVar->execute([(int)$newId, $cn, $cv, $admin_id]);
                        }
                    } catch (Exception $e) {
                        error_log('devices/create save vars error: ' . $e->getMessage());
                    }

                    // audit
                    try {
                        $alog = $pdo->prepare('INSERT INTO audit_logs (admin_id, action, entity_type, entity_id, new_value, ip_address, user_agent) VALUES (?, ?, ?, ?, ?, ?, ?)');
                        $alog->execute([
                            $admin_id,
                            'create_device',
                            'device',
                            $newId,
                            json_encode(['device_name' => $name, 'device_type_id' => $device_type_id, 'mac' => $mac]),
                            $_SERVER['REMOTE_ADDR'] ?? null,
                            $_SERVER['HTTP_USER_AGENT'] ?? null
                        ]);
                    } catch (Exception $e) {
                        error_log('devices/create audit insert error: ' . $e->getMessage());
                    }

                    header('Location: /devices/list.php?created=' . (int)$newId);
                    exit;
                } catch (Exception $e) {
                    error_log('devices/create insert error: ' . $e->getMessage());
                    $error = 'Kon device niet aanmaken. Controleer logs.';
                }
            }
        }
    }
}
?>
<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="utf-8">
    <title>Nieuw device - Yealink Config Builder</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<?php if (file_exists(__DIR__ . '/../admin/_admin_nav.php')) include __DIR__ . '/../admin/_admin_nav.php'; ?>
<main class="container" style="max-width:900px; margin-top:20px;">
    <h2>Nieuw device</h2>

    <?php if ($error): ?><div class="alert alert-error"><?php echo htmlspecialchars($error); ?></div><?php endif; ?>

    <div class="card">
        <form method="post" novalidate>
            <input type="hidden" name="csrf_token" value="<?php echo htmlspecialchars($csrf); ?>">

            <div class="form-group">
                <label>Naam</label>
                <input name="device_name" type="text" required value="<?php echo htmlspecialchars($_POST['device_name'] ?? ''); ?>">
            </div>

            <div class="form-group">
                <label>Model</label>
                <select name="device_type_id" required>
                    <option value="">-- Kies model --</option>
                    <?php foreach ($types as $t): ?>
                        <option value="<?php echo (int)$t['id']; ?>" <?php echo (isset($_POST['device_type_id']) && $_POST['device_type_id'] == $t['id']) ? 'selected' : ''; ?>>
                            <?php echo htmlspecialchars($t['type_name']); ?>
                        </option>
                    <?php endforeach; ?>
                </select>
            </div>

            <div class="form-group">
                <label>MAC-adres (optioneel)</label>
                <input name="mac_address" type="text" placeholder="00:11:22:33:44:55" value="<?php echo htmlspecialchars($_POST['mac_address'] ?? ''); ?>">
            </div>

            <div class="form-group">
                <label>Beschrijving</label>
                <textarea name="description" rows="4"><?php echo htmlspecialchars($_POST['description'] ?? ''); ?></textarea>
            </div>

            <!-- Variables section -->
            <section class="card" style="margin-top:12px;">
                <h3>Variabelen (optioneel)</h3>
                <p class="small">Je kunt globale variabelen overschrijven voor dit device. Gebruik alleen A-Z0-9_ voor namen.</p>

                <?php if (!empty($global_vars)): ?>
                    <?php foreach ($global_vars as $gname => $gval): ?>
                        <div class="form-group">
                            <label><?php echo htmlspecialchars($gname); ?> <small>(global: <?php echo htmlspecialchars($gval); ?>)</small></label>
                            <input name="variables[<?php echo htmlspecialchars($gname); ?>]" type="text" value="<?php echo htmlspecialchars($_POST['variables'][$gname] ?? ''); ?>">
                        </div>
                    <?php endforeach; ?>
                <?php else: ?>
                    <p class="small">Geen globale variabelen gevonden.</p>
                <?php endif; ?>

                <div id="custom-vars">
                    <h4>Extra variabelen</h4>
                    <div class="form-group">
                        <input name="custom_var_name[]" placeholder="VARNAME (A-Z0-9_)" />
                        <input name="custom_var_value[]" placeholder="Value" />
                    </div>
                </div>
            </section>

            <div style="display:flex; gap:8px; margin-top:12px;">
                <button class="btn" type="submit">Aanmaken</button>
                <a class="btn" href="/devices/list.php" style="background:#6c757d; align-self:center;">Annuleren</a>
            </div>
        </form>
    </div>
</main>
</body>
</html>
PHP

          # devices/edit.php (with device variables load/save)
          cat > devices/edit.php <<'PHP'
<?php
session_start();
require_once __DIR__ . '/../config/database.php';
require_once __DIR__ . '/../includes/rbac.php';

if (!isset($_SESSION['admin_id'])) {
    header('Location: /login.php');
    exit;
}
$admin_id = (int) $_SESSION['admin_id'];

if (!has_permission($pdo, $admin_id, 'devices.manage')) {
    http_response_code(403);
    echo 'Toegang geweigerd.';
    exit;
}

if (empty($_SESSION['csrf_token'])) {
    $_SESSION['csrf_token'] = bin2hex(random_bytes(16));
}
$csrf = $_SESSION['csrf_token'];

$error = '';
$success = '';

$device_id = isset($_GET['id']) ? (int) $_GET['id'] : (int) ($_POST['id'] ?? 0);
if ($device_id <= 0) {
    header('Location: /devices/list.php');
    exit;
}

// Fetch device
try {
    $stmt = $pdo->prepare('SELECT d.*, dt.type_name AS model_name FROM devices d LEFT JOIN device_types dt ON d.device_type_id = dt.id WHERE d.id = ? LIMIT 1');
    $stmt->execute([$device_id]);
    $device = $stmt->fetch(PDO::FETCH_ASSOC);
    if (!$device) {
        header('Location: /devices/list.php?notfound=1');
        exit;
    }
} catch (Exception $e) {
    error_log('devices/edit fetch error: ' . $e->getMessage());
    echo 'Fout bij ophalen device. Controleer logs.';
    exit;
}

// Fetch device-specific vars
try {
    $dvstmt = $pdo->prepare('SELECT var_name, var_value FROM device_variables WHERE device_id = ?');
    $dvstmt->execute([$device_id]);
    $device_vars = $dvstmt->fetchAll(PDO::FETCH_KEY_PAIR);
} catch (Exception $e) {
    $device_vars = [];
}

// Load global vars
try {
    $vstmt = $pdo->query('SELECT var_name, var_value FROM variables ORDER BY var_name ASC');
    $global_vars = $vstmt->fetchAll(PDO::FETCH_KEY_PAIR);
} catch (Exception $e) {
    $global_vars = [];
}

// Fetch device types
try {
    $stmt = $pdo->query('SELECT id, type_name FROM device_types ORDER BY type_name ASC');
    $types = $stmt->fetchAll(PDO::FETCH_ASSOC);
} catch (Exception $e) {
    $types = [];
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (!hash_equals($csrf, $_POST['csrf_token'] ?? '')) {
        $error = 'Ongeldige aanvraag (CSRF).';
    } else {
        $name = trim((string)($_POST['device_name'] ?? ''));
        $device_type_id = (int)($_POST['device_type_id'] ?? 0);
        $mac_raw = trim((string)($_POST['mac_address'] ?? ''));
        $description = trim((string)($_POST['description'] ?? ''));
        $is_active = isset($_POST['is_active']) && $_POST['is_active'] == '1' ? 1 : 0;

        if ($name === '' || $device_type_id <= 0) {
            $error = 'Vul minimaal naam en model in.';
        } else {
            $mac = null;
            if ($mac_raw !== '') {
                $normalized = strtoupper(preg_replace('/[^0-9A-F]/i', '', $mac_raw));
                if (!preg_match('/^[0-9A-F]{12}$/', $normalized)) {
                    $error = 'Ongeldig MAC-adres.';
                } else {
                    $mac = implode(':', str_split($normalized, 2));
                }
            }

            if ($error === '') {
                try {
                    if ($mac !== null) {
                        $chk = $pdo->prepare('SELECT id FROM devices WHERE mac_address = ? AND id != ? LIMIT 1');
                        $chk->execute([$mac, $device_id]);
                        if ($chk->fetch()) {
                            $error = 'Er bestaat al een device met dit MAC-adres.';
                        }
                    }

                    if ($error === '') {
                        $stmt = $pdo->prepare('UPDATE devices SET device_name = ?, device_type_id = ?, mac_address = ?, description = ?, is_active = ?, updated_at = NOW() WHERE id = ?');
                        $stmt->execute([$name, $device_type_id, $mac, $description, $is_active, $device_id]);

                        // Save per-device variables (update/insert)
                        try {
                            $insVar = $pdo->prepare('INSERT INTO device_variables (device_id, var_name, var_value, created_by, created_at) VALUES (?, ?, ?, ?, NOW()) ON DUPLICATE KEY UPDATE var_value = VALUES(var_value), created_by = VALUES(created_by)');
                            $posted_vars = $_POST['variables'] ?? [];
                            foreach ($posted_vars as $varName => $varVal) {
                                $varName = strtoupper(trim((string)$varName));
                                $varVal = trim((string)$varVal);
                                if ($varName === '') continue;
                                if (!preg_match('/^[A-Z0-9_]+$/', $varName)) continue;
                                if ($varVal === '') {
                                    // delete empty override
                                    $del = $pdo->prepare('DELETE FROM device_variables WHERE device_id = ? AND var_name = ?');
                                    $del->execute([$device_id, $varName]);
                                } else {
                                    $insVar->execute([$device_id, $varName, $varVal, $admin_id]);
                                }
                            }
                            // custom vars
                            $custom_names = $_POST['custom_var_name'] ?? [];
                            $custom_vals  = $_POST['custom_var_value'] ?? [];
                            for ($i=0;$i<count($custom_names);$i++){
                                $cn = strtoupper(trim((string)$custom_names[$i] ?? ''));
                                $cv = trim((string)$custom_vals[$i] ?? '');
                                if ($cn === '') continue;
                                if (!preg_match('/^[A-Z0-9_]+$/', $cn)) continue;
                                if ($cv === '') {
                                    $del = $pdo->prepare('DELETE FROM device_variables WHERE device_id = ? AND var_name = ?');
                                    $del->execute([$device_id, $cn]);
                                } else {
                                    $insVar->execute([$device_id, $cn, $cv, $admin_id]);
                                }
                            }
                        } catch (Exception $e) {
                            error_log('devices/edit save vars error: ' . $e->getMessage());
                        }

                        // audit
                        try {
                            $alog = $pdo->prepare('INSERT INTO audit_logs (admin_id, action, entity_type, entity_id, old_value, new_value, ip_address, user_agent) VALUES (?, ?, ?, ?, ?, ?, ?, ?)');
                            $alog->execute([
                                $admin_id,
                                'update_device',
                                'device',
                                $device_id,
                                json_encode($device),
                                json_encode(['device_name' => $name, 'device_type_id' => $device_type_id, 'mac_address' => $mac, 'description' => $description, 'is_active' => $is_active]),
                                $_SERVER['REMOTE_ADDR'] ?? null,
                                $_SERVER['HTTP_USER_AGENT'] ?? null
                            ]);
                        } catch (Exception $e) {
                            error_log('devices/edit audit error: ' . $e->getMessage());
                        }

                        $success = 'Device bijgewerkt.';

                        // Refresh device and vars
                        $stmt = $pdo->prepare('SELECT d.*, dt.type_name AS model_name FROM devices d LEFT JOIN device_types dt ON d.device_type_id = dt.id WHERE d.id = ? LIMIT 1');
                        $stmt->execute([$device_id]);
                        $device = $stmt->fetch(PDO::FETCH_ASSOC);

                        $dvstmt = $pdo->prepare('SELECT var_name, var_value FROM device_variables WHERE device_id = ?');
                        $dvstmt->execute([$device_id]);
                        $device_vars = $dvstmt->fetchAll(PDO::FETCH_KEY_PAIR);
                    }
                } catch (Exception $e) {
                    error_log('devices/edit update error: ' . $e->getMessage());
                    $error = 'Kon device niet bijwerken. Controleer logs.';
                }
            }
        }
    }
}
?>
<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="utf-8">
    <title>Device bewerken - Yealink Config Builder</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<?php if (file_exists(__DIR__ . '/../admin/_admin_nav.php')) include __DIR__ . '/../admin/_admin_nav.php'; ?>
<main class="container" style="max-width:900px; margin-top:20px;">
    <h2>Device bewerken</h2>

    <?php if ($error): ?><div class="alert alert-error"><?php echo htmlspecialchars($error); ?></div><?php endif; ?>
    <?php if ($success): ?><div class="alert alert-success"><?php echo htmlspecialchars($success); ?></div><?php endif; ?>

    <div class="card">
        <form method="post" novalidate>
            <input type="hidden" name="csrf_token" value="<?php echo htmlspecialchars($csrf); ?>">
            <input type="hidden" name="id" value="<?php echo (int)$device_id; ?>">

            <div class="form-group">
                <label>Naam</label>
                <input name="device_name" type="text" required value="<?php echo htmlspecialchars($_POST['device_name'] ?? $device['device_name']); ?>">
            </div>

            <div class="form-group">
                <label>Model</label>
                <select name="device_type_id" required>
                    <option value="">-- Kies model --</option>
                    <?php foreach ($types as $t): ?>
                        <?php $sel = ((isset($_POST['device_type_id']) && $_POST['device_type_id'] == $t['id']) || (!isset($_POST['device_type_id']) && $device['device_type_id'] == $t['id'])) ? 'selected' : ''; ?>
                        <option value="<?php echo (int)$t['id']; ?>" <?php echo $sel; ?>><?php echo htmlspecialchars($t['type_name']); ?></option>
                    <?php endforeach; ?>
                </select>
            </div>

            <div class="form-group">
                <label>MAC-adres (optioneel)</label>
                <input name="mac_address" type="text" placeholder="00:11:22:33:44:55" value="<?php echo htmlspecialchars($_POST['mac_address'] ?? $device['mac_address']); ?>">
            </div>

            <div class="form-group">
                <label>Beschrijving</label>
                <textarea name="description" rows="4"><?php echo htmlspecialchars($_POST['description'] ?? $device['description']); ?></textarea>
            </div>

            <!-- Variables section -->
            <section class="card" style="margin-top:12px;">
                <h3>Variabelen (optioneel)</h3>
                <p class="small">Je kunt globale variabelen overschrijven voor dit device. Gebruik alleen A-Z0-9_ voor namen.</p>

                <?php
                // show global vars with device overrides
                $merged_keys = array_unique(array_merge(array_keys($global_vars), array_keys($device_vars)));
                if (!empty($merged_keys)):
                    foreach ($merged_keys as $gname):
                        $gval = $global_vars[$gname] ?? '';
                        $dval = $device_vars[$gname] ?? '';
                        $inputVal = $_POST['variables'][$gname] ?? $dval ?? $gval;
                ?>
                    <div class="form-group">
                        <label><?php echo htmlspecialchars($gname); ?> <small>(global: <?php echo htmlspecialchars($gval); ?>)</small></label>
                        <input name="variables[<?php echo htmlspecialchars($gname); ?>]" type="text" value="<?php echo htmlspecialchars($inputVal); ?>">
                    </div>
                <?php
                    endforeach;
                else:
                ?>
                    <p class="small">Geen globale of device-variabelen gevonden.</p>
                <?php endif; ?>

                <div id="custom-vars">
                    <h4>Extra variabelen</h4>
                    <?php
                    // existing custom device vars not in global
                    foreach ($device_vars as $k=>$v) {
                        if (array_key_exists($k, $global_vars)) continue;
                    ?>
                        <div class="form-group">
                            <input name="custom_var_name[]" value="<?php echo htmlspecialchars($k); ?>" />
                            <input name="custom_var_value[]" value="<?php echo htmlspecialchars($v); ?>" />
                        </div>
                    <?php } ?>
                    <!-- blank template row -->
                    <div class="form-group">
                        <input name="custom_var_name[]" placeholder="VARNAME (A-Z0-9_)" />
                        <input name="custom_var_value[]" placeholder="Value" />
                    </div>
                </div>
            </section>

            <div style="display:flex; gap:8px; margin-top:12px;">
                <button class="btn" type="submit">Opslaan</button>
                <a class="btn" href="/devices/list.php" style="background:#6c757d;">Terug naar lijst</a>
                <a class="btn" href="/devices/delete.php?id=<?php echo (int)$device_id; ?>" style="background:#dc3545;">Verwijderen</a>
            </div>
        </form>
    </div>
</main>
</body>
</html>
PHP

      - name: Commit changes and push branch
        env:
          BRANCH: feature/migrate-device-type
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b "${BRANCH}"
          git add db/migrations/*.sql scripts/apply_migration_and_permissions.php devices/create.php devices/edit.php || true
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Migrate devices.model -> device_type_id; add device variable tables and apply script; update devices UI for per-device variables"
            git push --set-upstream origin "${BRANCH}"
          fi

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: Migrate devices.model -> device_type_id and add per-device variables (migration + script + UI)
          body: |
            Deze PR voegt:
            - Migration: db/migrations/2026_02_migrate_devices_to_device_type_id.sql
            - Migration: db/migrations/2026_02_add_device_variables.sql
            - CLI apply-script: scripts/apply_migration_and_permissions.php (draait beide migraties en voegt RBAC permissies)
            - UI updates: devices/create.php, devices/edit.php (per-device variabelen overschrijven)
            
            Voer altijd een DB-backup uit en test op staging. Het apply-script werkt eerst in dry-run; run met --yes om echt uit te voeren.
          base: main
          head: feature/migrate-device-type
          draft: false